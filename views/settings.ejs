<!-- For now setting page is just change password this can be updated later -->
<%- include('partials/header', {title: 'Change Password - Finance Tracker'}) %>
<%- include('partials/navbar', {activePage: 'settings', user: user}) %>

<div class="main-content">
    <div class="form-container">
        <div class="form-header">
            <h2>Change Password</h2>
            <a href="/dashboard" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span><%= error %></span>
            </div>
        <% } %>

        <% if (typeof success !== 'undefined' && success) { %>
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <span><%= success %></span>
            </div>
        <% } %>

        <form class="password-form" action="/change-password" method="POST">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input 
                    type="password" 
                    id="currentPassword" 
                    name="currentPassword" 
                    required
                    autocomplete="current-password"
                >
                <i class="fas fa-lock input-icon"></i>
                <button type="button" class="password-toggle" data-target="currentPassword">
                    <i class="fas fa-eye"></i>
                </button>
            </div>

            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input 
                    type="password" 
                    id="newPassword" 
                    name="newPassword" 
                    required
                    minlength="6"
                    autocomplete="new-password"
                >
                <i class="fas fa-lock input-icon"></i>
                <button type="button" class="password-toggle" data-target="newPassword">
                    <i class="fas fa-eye"></i>
                </button>
                <div class="password-requirements">
                    Must be at least 6 characters long
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    required
                    autocomplete="new-password"
                >
                <i class="fas fa-lock input-icon"></i>
                <button type="button" class="password-toggle" data-target="confirmPassword">
                    <i class="fas fa-eye"></i>
                </button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-key"></i> Change Password
                </button>
                <button type="reset" class="btn btn-secondary">Clear</button>
            </div>
        </form>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Password visibility toggle
        const toggleButtons = document.querySelectorAll('.password-toggle');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            });
        });

        // Form validation
        const form = document.querySelector('.password-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const currentPassword = document.getElementById('currentPassword');
                const newPassword = document.getElementById('newPassword');
                const confirmPassword = document.getElementById('confirmPassword');
                
                let isValid = true;

                // Clear previous errors
                [currentPassword, newPassword, confirmPassword].forEach(input => {
                    input.classList.remove('error');
                });

                // Validate current password
                if (!currentPassword.value.trim()) {
                    currentPassword.classList.add('error');
                    isValid = false;
                }

                // Validate new password
                if (!newPassword.value.trim()) {
                    newPassword.classList.add('error');
                    isValid = false;
                } else if (newPassword.value.length < 6) {
                    newPassword.classList.add('error');
                    isValid = false;
                    alert('New password must be at least 6 characters long');
                }

                // Validate password confirmation
                if (!confirmPassword.value.trim()) {
                    confirmPassword.classList.add('error');
                    isValid = false;
                } else if (newPassword.value !== confirmPassword.value) {
                    confirmPassword.classList.add('error');
                    isValid = false;
                    alert('New passwords do not match');
                }

                if (!isValid) {
                    e.preventDefault();
                }
            });

            // Clear error when user starts typing
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.classList.contains('error')) {
                        this.classList.remove('error');
                    }
                });
            });

            // Real-time password confirmation validation
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            confirmPasswordInput.addEventListener('input', function() {
                if (newPasswordInput.value !== this.value) {
                    this.classList.add('error');
                } else {
                    this.classList.remove('error');
                }
            });
        }
    });
</script>