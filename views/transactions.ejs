<%- include('partials/header', {title: editing ? 'Edit Transaction' : 'Add Transaction'}) %>
<%- include('partials/navbar', {activePage: 'transactions', user: user}) %>

<div class="main-content">
    <div class="form-container">
        <div class="form-header">
            <h2><%= editing ? 'Edit Transaction' : 'Add New Transaction' %></h2>
            <a href="/dashboard" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>



        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span><%= error %></span>
            </div>
        <% } %>

        <form class="transaction-form"   action="<%= editing ? '/transactions/edit/' + transaction.id + '?_method=PUT' : '/transactions/add' %>" 
  method="POST">
            <div class="form-row">
                <div class="form-group">
                    <label for="amount">Amount *</label>
                    <input 
                        type="number" 
                        id="amount" 
                        name="amount" 
                        step="0.01" 
                        min="0.01"
                        value="<%= transaction ? transaction.amount : '' %>" 
                        required
                        placeholder="0.00"
                    >
                  <i class="input-icon naira-icon">â‚¦</i>
                </div>

                <div class="form-group">
                    <label for="date">Date *</label>
                    <input 
                        type="date" 
                        id="date" 
                        name="date" 
                        value="<%= transaction ? new Date(transaction.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>" 
                        required
                    >
                    <i class="fas fa-calendar input-icon"></i>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Type *</label>
                    <div class="radio-group">
                        <label class="radio-container">
                            <input 
                                type="radio" 
                                name="type" 
                                value="income" 
                                <%= transaction && transaction.type === 'income' ? 'checked' : '' %>
                                required
                            >
                            <span class="radio-checkmark"></span>
                            <span class="radio-label">
                                <i class="fas fa-arrow-down income-icon"></i> Income
                            </span>
                        </label>
                        
                        <label class="radio-container">
                            <input 
                                type="radio" 
                                name="type" 
                                value="expense" 
                                <%= transaction && transaction.type === 'expense' ? 'checked' : (editing ? '' : 'checked') %>
                            >
                            <span class="radio-checkmark"></span>
                            <span class="radio-label">
                                <i class="fas fa-arrow-up expense-icon"></i> Expense
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" name="category_id" required>
                        <option value="">Select a category</option>
                        <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
                            <% categories.forEach(category => { %>
                                <option 
                                    value="<%= category.id || category._id %>" 
                                    <%= transaction && (transaction.category_id == category.id || transaction.category_id == category._id) ? 'selected' : '' %>
                                    data-type="<%= category.type || 'expense' || 'income' %>"
                                >
                                    <%= category.name %>
                                </option>
                            <% }) %>
                        <% } else { %>
                            <option value="" disabled>No categories available</option>
                        <% } %>
                    </select>
                    <i class="fas fa-tag input-icon"></i>
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea 
                    id="description" 
                    name="description" 
                    rows="3" 
                    placeholder="Add a note about this transaction"
                ><%= transaction ? transaction.description : '' %></textarea>
                <i class="fas fa-pen input-icon textarea-icon"></i>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">
                    <i class="fas fa-check"></i> <%= editing ? 'Update Transaction' : 'Add Transaction' %>
                </button>
                
                <% if (editing) { %>
                    <a href="/dashboard" class="btn btn-secondary">Cancel</a>
                <% } else { %>
                    <button type="reset" class="btn btn-secondary">Clear Form</button>
                <% } %>
            </div>
        </form>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const typeRadios = document.querySelectorAll('input[name="type"]');
        const categorySelect = document.getElementById('category');
        
        // Filter categories based on selected type
        function filterCategories() {
            const selectedType = document.querySelector('input[name="type"]:checked').value;
            const options = categorySelect.options;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value === "") continue; // Skip the placeholder option
                
                const optionType = option.getAttribute('data-type');
                if (optionType === selectedType) {
                    option.style.display = '';
                    option.disabled = false;
                } else {
                    option.style.display = 'none';
                    option.disabled = true;
                }
            }
            
            // Reset selection if current selection doesn't match type
            const selectedOption = options[categorySelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                categorySelect.selectedIndex = 0;
            }
        }
        
        // Initial filter
        if (typeRadios.length > 0 && categorySelect) {
            filterCategories();
            
            // Add event listeners to radio buttons
            typeRadios.forEach(radio => {
                radio.addEventListener('change', filterCategories);
            });
        }
        
        // Format amount field on blur
        const amountInput = document.getElementById('amount');
        if (amountInput) {
            amountInput.addEventListener('blur', function() {
                if (this.value) {
                    this.value = parseFloat(this.value).toFixed(2);
                }
            });
        }
    });
</script>